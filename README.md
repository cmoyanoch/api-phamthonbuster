# üöÄ API Phantombuster Real - Servidor de Producci√≥n

## üìã Descripci√≥n

API de producci√≥n que integra directamente con la API real de Phantombuster para extracci√≥n de leads de LinkedIn. El servidor ejecuta b√∫squedas reales en Phantombuster y procesa los resultados incluyendo el campo `connectionDegree` para clasificaci√≥n autom√°tica de leads.

## ‚ú® Caracter√≠sticas Principales

### üîÑ Integraci√≥n Real con Phantombuster

- **API Real**: Integraci√≥n directa con la API oficial de Phantombuster
- **B√∫squedas en tiempo real**: Ejecuta b√∫squedas reales en LinkedIn a trav√©s de Phantombuster
- **Monitoreo de estado**: Consulta el progreso real de las b√∫squedas en Phantombuster
- **Resultados reales**: Procesa y enriquece los datos reales extra√≠dos de LinkedIn

### üéØ Clasificaci√≥n Autom√°tica de Leads

- **connectionDegree**: Campo autom√°tico basado en datos reales de LinkedIn
- **Mapeo inteligente**: Determina el grado de conexi√≥n (`1st`, `2nd`, `3rd`) basado en:
  - Conexiones mutuas
  - Nivel de conexi√≥n en LinkedIn
  - Informaci√≥n de red directa
- **Clasificaci√≥n por tipo**: Mapea autom√°ticamente a tipos de lead (`hot`, `warm`, `cold`)

### üåç Procesamiento de Datos Reales

- **Datos reales de LinkedIn**: Nombres, empresas, ubicaciones reales
- **Informaci√≥n de conexiones**: Datos reales de la red de LinkedIn
- **Enriquecimiento autom√°tico**: Agrega campos adicionales como `connectionDegree`
- **Validaci√≥n de datos**: Procesa y valida los datos recibidos de Phantombuster

## üõ†Ô∏è Tecnolog√≠as Utilizadas

- **Node.js** - Runtime de JavaScript
- **Express.js** - Framework web
- **Helmet** - Seguridad HTTP
- **CORS** - Cross-Origin Resource Sharing
- **Morgan** - Logging de requests
- **Compression** - Compresi√≥n de respuestas
- **Rate Limiting** - Limitaci√≥n de requests
- **Docker** - Containerizaci√≥n

## üöÄ Instalaci√≥n y Configuraci√≥n

### Prerrequisitos

- Docker y Docker Compose
- Node.js 18+ (para desarrollo local)

### 1. Clonar el Repositorio

```bash
git clone <repository-url>
cd api-phamthonbuster
```

### 2. Configurar Variables de Entorno

```bash
# Copiar archivo de configuraci√≥n
cp env.example env

# Editar variables de entorno
nano env
```

### 3. Variables de Entorno Principales

```bash
# Configuraci√≥n del servidor
NODE_ENV=production
PORT=3001
SKIP_DATABASE=true

# API Key para autenticaci√≥n
API_KEY=your-secure-api-key

# Phantombuster API (REQUERIDO para producci√≥n)
PHANTOMBUSTER_API_KEY=your-phantombuster-api-key
PHANTOMBUSTER_AGENT_ID=your-phantombuster-agent-id

# Redis (opcional para cache)
REDIS_URL=redis://localhost:6379
```

### ‚ö†Ô∏è Configuraci√≥n de Phantombuster

Para usar la API real de Phantombuster, necesitas:

1. **API Key de Phantombuster**: Obt√©n tu API key desde el panel de Phantombuster
2. **Agent ID**: ID del agente de LinkedIn que quieres usar para las b√∫squedas
3. **Configurar el agente**: Aseg√∫rate de que tu agente est√© configurado correctamente en Phantombuster

### 4. Ejecutar con Docker

```bash
# Construir y ejecutar
docker compose up --build -d

# Ver logs
docker compose logs -f phantombuster-api

# Detener
docker compose down
```

### 5. Verificar Instalaci√≥n

```bash
# Health check
curl http://localhost:3001/health

# Verificar API
curl http://localhost:3001/api/health
```

## üìä Estructura de Datos

### Par√°metros de B√∫squeda

```json
{
  "searchParams": {
    "job_title": "string", // T√≠tulo de trabajo
    "industry_codes": ["string"], // C√≥digos de industria
    "location": "string" // Ubicaci√≥n (ciudades, pa√≠s)
  },
  "options": {
    "numberOfResultsPerSearch": 100, // N√∫mero de resultados
    "numberOfPagesPerSearch": 10, // P√°ginas por b√∫squeda
    "removeDuplicateProfiles": true, // Eliminar duplicados
    "includeEmails": true // Incluir emails
  }
}
```

### Estructura de Resultados

```json
{
  "linkedin_url": "string", // URL del perfil de LinkedIn
  "first_name": "string", // Nombre
  "last_name": "string", // Apellido
  "headline": "string", // T√≠tulo profesional
  "company_name": "string", // Nombre de la empresa
  "location": "string", // Ubicaci√≥n
  "industry": "string", // Industria
  "profile_url": "string", // URL del perfil
  "email": "string|null", // Email (puede ser null)
  "phone": "string", // Tel√©fono
  "extracted_at": "string" // Fecha de extracci√≥n
}
```

### Clasificaci√≥n Autom√°tica de Leads por Grado de Conexi√≥n

Cuando env√≠as un array de leads con el campo `connectionDegree` (`1st`, `2nd`, `3rd`), el endpoint `/api/leads/process` agrega autom√°ticamente el campo `leadType`:

- `1st` ‚Üí `hot` (contacto directo)
- `2nd` ‚Üí `warm` (segundo grado)
- `3rd` o cualquier otro ‚Üí `cold` (tercer grado o desconocido)

**Ejemplo de request:**

```json
{
  "leads": [
    { "first_name": "Juan", "connectionDegree": "1st" },
    { "first_name": "Ana", "connectionDegree": "2nd" },
    { "first_name": "Pedro", "connectionDegree": "3rd" }
  ]
}
```

**Respuesta:**

```json
{
  "success": true,
  "data": [
    { "first_name": "Juan", "connectionDegree": "1st", "leadType": "hot" },
    { "first_name": "Ana", "connectionDegree": "2nd", "leadType": "warm" },
    { "first_name": "Pedro", "connectionDegree": "3rd", "leadType": "cold" }
  ]
}
```

## üîç Endpoints Disponibles

### Health Check (Sin Autenticaci√≥n)

| M√©todo | Endpoint      | Descripci√≥n                 |
| ------ | ------------- | --------------------------- |
| GET    | `/health`     | Estado general del servidor |
| GET    | `/api/health` | Estado de la API            |

### Autenticaci√≥n y Configuraci√≥n

| M√©todo | Endpoint             | Descripci√≥n                       |
| ------ | -------------------- | --------------------------------- |
| GET    | `/api/auth/validate` | Validar API Key                   |
| GET    | `/api/config`        | Obtener configuraci√≥n del sistema |

### B√∫squeda Autom√°tica

| M√©todo | Endpoint                        | Descripci√≥n                                   |
| ------ | ------------------------------- | --------------------------------------------- |
| POST   | `/api/search/start`             | Iniciar b√∫squeda (completada autom√°ticamente) |
| GET    | `/api/search/status/:searchId`  | Estado de b√∫squeda                            |
| GET    | `/api/search/results/:searchId` | Obtener resultados                            |
| GET    | `/api/search/list`              | Listar todas las b√∫squedas                    |
| GET    | `/api/search/active`            | B√∫squedas activas                             |

### Procesamiento y Clasificaci√≥n de Leads

| M√©todo | Endpoint             | Descripci√≥n                                                          |
| ------ | -------------------- | -------------------------------------------------------------------- |
| POST   | `/api/leads/process` | Procesa un array de leads y agrega el campo leadType autom√°ticamente |

### Exportaci√≥n de Datos

| M√©todo | Endpoint                            | Descripci√≥n     |
| ------ | ----------------------------------- | --------------- |
| GET    | `/api/search/export/:searchId/json` | Exportar a JSON |
| GET    | `/api/search/export/:searchId/csv`  | Exportar a CSV  |

### Estad√≠sticas

| M√©todo | Endpoint              | Descripci√≥n            |
| ------ | --------------------- | ---------------------- |
| GET    | `/api/stats/overview` | Estad√≠sticas generales |

## üéØ Ejemplos de Uso

### 1. Procesar y clasificar leads por grado de conexi√≥n

```bash
curl -X POST http://localhost:3001/api/leads/process \
  -H "Content-Type: application/json" \
  -H "X-API-Key: dev-api-key-12345" \
  -d '{
    "leads": [
      { "first_name": "Juan", "connectionDegree": "1st" },
      { "first_name": "Ana", "connectionDegree": "2nd" },
      { "first_name": "Pedro", "connectionDegree": "3rd" }
    ]
  }'
```

### 2. B√∫squeda Real en Phantombuster

```bash
curl -X POST http://localhost:3001/api/search/start \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-secure-api-key" \
  -d '{
    "searchParams": {
      "job_title": "Software Engineer"
    },
    "options": {
      "numberOfResultsPerSearch": 10,
      "includeEmails": true
    }
  }'
```

**Respuesta:**

```json
{
  "success": true,
  "message": "B√∫squeda iniciada en Phantombuster",
  "data": {
    "searchId": "search_1234567890_abc123",
    "containerId": "container_1234567890_xyz789",
    "status": "running",
    "progress": 10,
    "message": "La b√∫squeda est√° ejecut√°ndose en Phantombuster. Usa /api/search/status/:searchId para monitorear el progreso."
  }
}
```

### 3. B√∫squeda con Ubicaci√≥n Espec√≠fica (Francia)

```bash
curl -X POST http://localhost:3001/api/search/start \
  -H "Content-Type: application/json" \
  -H "X-API-Key: dev-api-key-12345" \
  -d '{
    "searchParams": {
      "job_title": "Supply Chain Director",
      "industry_codes": ["20","27","50","53","96"],
      "location": "Paris, Lyon, Marseille, Toulouse, Nice, Lille, France"
    },
    "options": {
      "numberOfResultsPerSearch": 50,
      "numberOfPagesPerSearch": 5,
      "removeDuplicateProfiles": true,
      "includeEmails": true
    }
  }'
```

### 4. B√∫squeda con Industrias Espec√≠ficas

```bash
curl -X POST http://localhost:3001/api/search/start \
  -H "Content-Type: application/json" \
  -H "X-API-Key: dev-api-key-12345" \
  -d '{
    "searchParams": {
      "job_title": "Marketing Manager",
      "industry_codes": ["4", "6"]
    },
    "options": {
      "numberOfResultsPerSearch": 15,
      "removeDuplicateProfiles": true,
      "includeEmails": true
    }
  }'
```

### 5. Monitorear Estado de B√∫squeda

```bash
curl -X GET "http://localhost:3001/api/search/status/SEARCH_ID" \
  -H "X-API-Key: your-secure-api-key"
```

**Respuesta:**

```json
{
  "success": true,
  "data": {
    "searchId": "search_1234567890_abc123",
    "containerId": "container_1234567890_xyz789",
    "status": "running",
    "progress": 45,
    "totalResults": 0
  }
}
```

### 6. Obtener Resultados Reales

```bash
curl -X GET "http://localhost:3001/api/search/results/SEARCH_ID" \
  -H "X-API-Key: your-secure-api-key"
```

**Respuesta con connectionDegree:**

```json
{
  "success": true,
  "data": {
    "searchId": "search_1234567890_abc123",
    "status": "completed",
    "leads": [
      {
        "linkedin_url": "https://linkedin.com/in/john-doe",
        "first_name": "John",
        "last_name": "Doe",
        "headline": "Software Engineer at Tech Corp",
        "company_name": "Tech Corp",
        "location": "San Francisco, CA",
        "industry": "Technology",
        "email": "john.doe@techcorp.com",
        "phone": "+1 (555) 123-4567",
        "connectionDegree": "2nd",
        "mutual_connections": 5,
        "connection_level": 2,
        "extracted_at": "2024-01-05T17:12:00.000Z"
      }
    ],
    "total": 1,
    "connectionDegree_available": true
  }
}
```

### 6. Exportar Datos

```bash
# Exportar a JSON
curl -X GET "http://localhost:3001/api/search/export/SEARCH_ID/json" \
  -H "X-API-Key: dev-api-key-12345" > results.json

# Exportar a CSV
curl -X GET "http://localhost:3001/api/search/export/SEARCH_ID/csv" \
  -H "X-API-Key: dev-api-key-12345" > results.csv
```

## üó∫Ô∏è Mapeo de Industrias

El servidor mapea autom√°ticamente los c√≥digos de industria a nombres legibles:

| C√≥digo | Industria      |
| ------ | -------------- |
| 4      | Technology     |
| 6      | Finance        |
| 20     | Manufacturing  |
| 27     | Transportation |
| 50     | Supply Chain   |
| 53     | Logistics      |
| 96     | Retail         |

## üåç Soporte de Pa√≠ses

### Francia üá´üá∑

- **Nombres**: Jean, Marie, Pierre, Sophie, Fran√ßois, etc.
- **Empresas**: LVMH, TotalEnergies, BNP Paribas, Carrefour, Orange, Sanofi, etc.
- **Tel√©fonos**: Formato `+33 X XX XX XX`
- **Detectado por**: `location` contiene "France"

### Espa√±a üá™üá∏

- **Nombres**: Juan, Mar√≠a, Carlos, Ana, Luis, Carmen, etc.
- **Empresas**: Inditex, Santander, Telef√≥nica, BBVA, Iberdrola, etc.
- **Tel√©fonos**: Formato `+34 XXX XXX XXX`
- **Detectado por**: `location` contiene "Spain"

### Internacional üåê

- **Nombres**: John, Mary, James, Patricia, Robert, etc.
- **Empresas**: TechCorp, InnovateLab, Digital Solutions, etc.
- **Tel√©fonos**: Formato `+1 XXX XXX XXXX`
- **Detectado por**: Ubicaci√≥n no espec√≠fica

## üîß Configuraci√≥n Avanzada

### Rate Limiting

```javascript
// Configurado en el servidor
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 100, // m√°ximo 100 requests por ventana
});
```

### Seguridad

- **Helmet**: Headers de seguridad HTTP
- **CORS**: Configuraci√≥n de cross-origin
- **Compression**: Compresi√≥n de respuestas
- **API Key**: Autenticaci√≥n requerida

### Logging

- **Morgan**: Logging de requests HTTP
- **Console**: Logs de aplicaci√≥n
- **Error Handling**: Manejo centralizado de errores

## üìà Monitoreo y Estad√≠sticas

### Estad√≠sticas Disponibles

- Total de b√∫squedas realizadas
- B√∫squedas completadas vs. fallidas
- Total de leads extra√≠dos
- √öltima extracci√≥n realizada

### Health Check

```bash
# Verificar estado del servidor
curl http://localhost:3001/health

# Respuesta esperada
{
  "status": "ok",
  "timestamp": "2025-07-07T01:44:28.452Z",
  "version": "1.0.0",
  "environment": "development",
  "database": "memory"
}
```

## üêõ Soluci√≥n de Problemas

### Problemas Comunes

1. **API Key inv√°lida**

   ```bash
   # Verificar API Key en el archivo env
   cat env | grep API_KEY
   ```

2. **Puerto ocupado**

   ```bash
   # Cambiar puerto en env
   PORT=3002
   ```

3. **Docker no inicia**

   ```bash
   # Verificar logs
   docker compose logs phantombuster-api

   # Reconstruir
   docker compose down
   docker compose up --build -d
   ```

4. **B√∫squeda no genera resultados**
   - Verificar par√°metros de b√∫squeda
   - Comprobar que la ubicaci√≥n sea v√°lida
   - Revisar c√≥digos de industria

### Logs de Debug

```bash
# Ver logs en tiempo real
docker compose logs -f phantombuster-api

# Ver logs espec√≠ficos
docker compose logs phantombuster-api | grep "ERROR"
```

## üîÑ Desarrollo Local

### Instalaci√≥n de Dependencias

```bash
npm install
```

### Ejecutar en Desarrollo

```bash
npm start
# o
node server-enhanced.js
```

### Variables de Entorno de Desarrollo

```bash
NODE_ENV=development
PORT=3001
API_KEY=dev-api-key-12345
SKIP_DATABASE=true
```

## üìù Notas de Implementaci√≥n

### Almacenamiento en Memoria

- Los datos se almacenan en memoria (Map)
- No hay persistencia entre reinicios
- Ideal para desarrollo y pruebas

### B√∫squeda Autom√°tica

- Se completa inmediatamente al iniciar
- Genera datos simulados realistas
- No requiere monitoreo de estado

### Datos Simulados

- Basados en par√°metros de b√∫squeda
- Localizados seg√∫n pa√≠s/ubicaci√≥n
- Incluyen todos los campos requeridos

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crear una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abrir un Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT. Ver el archivo `LICENSE` para m√°s detalles.

## üÜò Soporte

Para soporte t√©cnico o preguntas:

- Crear un issue en el repositorio
- Revisar la documentaci√≥n de la API
- Verificar los logs del servidor

---

**¬°Disfruta usando la API de Phantombuster Local! üöÄ**

# api-phamthonbuster
